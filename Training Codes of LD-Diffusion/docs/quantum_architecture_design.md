# 量子架构设计：潜空间 QCNN 前端

## 概述
本文档详细介绍了 **潜空间量子前端 (Latent-Space Quantum FrontEnd)** 的架构。这是一个完全量子化的模块，旨在替代扩散模型 UNetBlock 中的经典 AdaGN (自适应组归一化) 和卷积层。

该架构设计用于直接在潜空间特征上运行，利用量子纠缠进行空间特征提取和时间嵌入调制。

## 核心组件

### 1. 量子时间态生成 (Quantum Time State Generation - QuantumMLP_State)
我们不再立即测量时间嵌入，而是将其保持为量子态，通过纠缠来调制图像特征。

*   **输入**: 经典时间嵌入 $t_{emb}$。
*   **过程**:
    *   编码: $t_{emb} \rightarrow |\psi_0\rangle$。
    *   演化: $U_{mlp}(\theta) |\psi_0\rangle \rightarrow |\psi_{time}\rangle$ ($N_a$ 个辅助量子比特上的状态)。
*   **输出**: 量子态 $|\psi_{time}\rangle$。

### 2. 量子前端 QCNN (QuantumFrontEndQCNN)
一个融合模块，同时处理空间特征提取和时间调制。

*   **输入**:
    *   $x_{patch}$: 图像 Patch 特征 (经典)。
    *   $|\psi_{time}\rangle$: 时间嵌入状态 (量子，在辅助量子比特上)。

*   **量子比特布局**:
    *   **数据量子比特 ($N_d$)**: 编码图像 Patch 特征。
    *   **辅助量子比特 ($N_a$)**: 承载时间信息。
    *   **总数**: $N = N_d + N_a$。

*   **电路流程**:

    #### 步骤 1: 初始化
    *   将 $|\psi_{time}\rangle$ 加载到辅助量子比特上。
    *   使用 **RY 旋转** (基础编码) 将 $x_{patch}$ 编码到数据量子比特上。

    #### 步骤 2: 逐层演化 (重复 $L$ 次)
    *   **时间调制 (纠缠)**:
        *   应用 **受控旋转门** (例如 $CRX$, $CZ$)，其中辅助比特为控制位，数据比特为目标位。
        *   这通过量子干涉将时间信息“注入”到空间特征中。
    *   **空间特征提取 (多尺度 QCNN 块)**:
        *   在数据量子比特上应用 **增强型 HEA**。
        *   **多尺度纠缠**: 除了最近邻 CNOTs ($i, i+1$)，引入跨步 CNOTs ($i, i+k$, 例如 $k=2$)。
        *   **优势**: 模拟类似经典“空洞卷积”的机制，扩大有效感受野，捕捉更长距离的像素关联。
    *   **数据重上传 (非线性增强)**:
        *   使用 **不同的基** (例如 $RZ$ 或 $RX$) 再次将 $x_{patch}$ 编码到数据量子比特上。
        *   这显著增强了电路的表达能力 (通用近似)。

    #### 步骤 3: 可训练测量
    *   在数据量子比特上应用最终的可训练酉变换 $U_{basis}(\phi)$。
    *   在 Z 基上测量数据量子比特以获得 $y_{quant}$。
    *   丢弃 (Trace out) 辅助量子比特。

    #### 步骤 4: 经典残差连接
    *   $y_{out} = y_{quant} + \text{Linear}(x_{patch})$。
    *   **机制**: 一个并行的经典线性层处理输入 Patch $x_{patch}$，并将其输出加到量子测量结果 $y_{quant}$ 上。
    *   **优势**:
        *   **训练稳定性**: 确保模型在量子电路初始化于贫瘠高原或随机状态时，能够默认退化为线性变换。
        *   **梯度流**: 为梯度提供一条直接回流到输入的路径，防止深层量子电路中的梯度消失。
        *   **恒等映射**: 促进恒等类映射的学习，这在类 ResNet 架构 (如 UNet) 中通常至关重要。

## 实现细节

### 待研究的电路结构
*   **纠缠拓扑**: 环形、线性还是全连接？(根据 QCNN 论文决定)。
*   **门集合**: $RY/RZ/CNOT$ vs. $RX/RY/CZ$。
*   **池化**: 我们需要量子池化 (测量子集) 还是全测量？(当前计划: 全测量以保留特征图)。

### 训练策略: 逐层训练
为了缓解 **贫瘠高原 (Barren Plateau)** 问题 (梯度随量子比特数和电路深度指数级消失)，我们实施渐进式的 **逐层训练** 协议。

*   **机制**:
    1.  **阶段 1 (浅层)**: 仅训练 PQC 的前 $k$ 层 (例如 $k=1$)。深层参数被冻结或旁路。
    2.  **阶段 2 (增长)**: 逐渐解冻或添加后续层 (例如 $k=2, 3, \dots, L$)。
    3.  **阶段 3 (深层)**: 训练完整的深层电路。
*   **接口**: `QuantumFrontEndQCNN` 模块暴露一个 `set_active_layers(n)` 方法。训练循环 (在 `train.py` 中) 应根据调度表 (例如每几个 epoch) 调用此方法来增加 `n`。
*   **优势**: 允许模型在尝试优化深度纠缠电路的复杂景观之前，先用浅层、可训练的电路学习粗粒度特征。

### 训练策略: 随机量子特征 (参数冻结)
受 *QCQ-CNN* 启发，固定参数的随机量子电路可以作为强大的非线性特征提取器，避免贫瘠高原并加速训练。

*   **机制**: 提供 `freeze_qcnn` 选项。
*   **行为**: 随机初始化 QCNN 主干参数 (纠缠层与旋转层)，并在训练期间将其冻结 (`requires_grad=False`)。仅训练 **时间调制层** (Ancilla-Data 接口) 和 **测量基**。
*   **适用场景**: 当发现全参数训练不稳定或过拟合时启用。

## 参考文献
*   *Cong, I., Choi, S. & Lukin, M. D. Quantum convolutional neural networks. Nat. Phys. 15, 1273–1278 (2019).*
*   *Pérez-Salinas, A., et al. Data-reuploading for a universal quantum classifier. Quantum 4, 226 (2020).*
*   *Mitarai, K., et al. Quantum circuit learning. Phys. Rev. A 98, 032309 (2018).*
